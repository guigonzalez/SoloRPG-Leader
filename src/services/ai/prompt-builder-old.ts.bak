import type { Campaign, Entity, Fact, Recap, Character } from '../../types/models';
import { getLanguage, getLanguageName } from '../storage/settings-storage';
import { getSystemTemplate } from '../game/attribute-templates';

/**
 * Get system-specific mechanical guidance
 * These are RULES, not conventions. Follow them precisely.
 */
function getSystemGuidance(system: string): string {
  const systemGuidance: Record<string, string> = {
    'D&D 5e': `**CORE MECHANICS** (d20 + modifier vs DC):
   - DCs: 5 (very easy), 10 (easy), 15 (medium), 20 (hard), 25 (very hard), 30 (nearly impossible)
   - Advantage/Disadvantage: roll 2d20, take higher/lower
   - Proficiency bonus: +2 to +6 based on level (add to proficient skills)
   - Critical: natural 20 = auto-success (attack), natural 1 = auto-fail (attack)
   - When to roll: uncertain outcomes only (don't roll for trivial tasks)
   - XP is NOT awarded per roll - award for story milestones only`,

    'Pathfinder 2e': `**CORE MECHANICS** (d20 + modifier vs DC):
   - Use Level-Based DCs: Level 0 = DC 14, Level 1 = DC 15, Level 2 = DC 16, etc.
   - Degrees of Success: ≥10 over DC = critical success, DC+ = success, DC-1 to DC-9 = failure, ≤10 under = critical failure
   - +/-10 rule: natural 20 improves degree by 1 step, natural 1 worsens by 1 step
   - Three action economy per turn
   - When to roll: uncertain outcomes only
   - XP is NOT awarded per roll - award for encounter/story milestones only`,

    'Call of Cthulhu': `**CORE MECHANICS** (roll d100 under skill):
   - Regular: roll ≤ skill value = success
   - Hard: roll ≤ half skill value = hard success
   - Extreme: roll ≤ one-fifth skill value = extreme success
   - Bonus/Penalty dice: roll extra d10s, use best/worst for tens digit
   - Pushing rolls: re-roll failed check with higher stakes
   - Sanity checks: encounter horror → lose sanity on failed POW check
   - DO NOT use DC system - this is percentile roll-under
   - XP from failed skill checks and scenarios, NOT successful rolls`,

    'Cyberpunk RED': `**CORE MECHANICS** (STAT + Skill + 1d10 vs DV):
   - DVs: 9 (everyday), 13 (professional), 15 (trained), 17 (difficult), 21 (very difficult), 24+ (heroic)
   - Critical: natural 10 = roll again and add; natural 1 = fumble (roll again, if 1 again = disaster)
   - Armor: subtracts from damage
   - Cover/Called Shots: modify DV
   - When to roll: risky actions, combat, skill checks
   - XP from missions and milestones, NOT individual rolls`,

    'Vampire: The Masquerade': `**CORE MECHANICS V5** (dice pool system):
   - Roll: Attribute + Skill dice (d10s)
   - Count successes: 6+ = success
   - Difficulty = number of successes needed (typically 1-3, rarely 4+)
   - Hunger dice: some dice are Hunger dice (different color/tracking)
   - Messy Critical: pair of 10s on Hunger dice = succeed but with Beast complication
   - Bestial Failure: fail with Hunger dice showing 1s = frenzy/compulsion
   - DO NOT use DC or difficulty 6+/7+/8+ - that's old editions
   - DO NOT use d20 - this is a d10 pool system
   - XP from sessions and stories, NOT rolls`,

    'Fate Core': `**CORE MECHANICS** (4dF + skill vs difficulty):
   - Roll 4dF (Fudge dice: +, -, or blank) + skill rating
   - Ladder: Terrible (-2), Poor (-1), Mediocre (0), Average (1), Fair (2), Good (3), Great (4), Superb (5), etc.
   - Aspects: invoke for +2 or reroll (costs Fate point)
   - Compels: accept complication for Fate point
   - Stress & Consequences instead of HP
   - Create Advantage: establish aspects
   - DO NOT use DC system - use narrative positioning and opposition
   - XP (milestones) from sessions, NOT rolls`,

    'Powered by the Apocalypse': `**CORE MECHANICS** (2d6 + stat):
   - Moves triggered by fiction, NOT arbitrary rolls
   - Results: 10+ = success, 7-9 = partial success/cost, 6- = failure/complication (GM makes move)
   - Player-facing rolls (players roll, GM doesn't)
   - Moves advance narrative (no "roll to see if you succeed" without fictional trigger)
   - DO NOT use DC system or request rolls without move trigger
   - DO NOT assign arbitrary difficulties
   - XP from failed rolls and end-of-session questions`,

    'OSR (Old School Renaissance)': `**CORE MECHANICS** (varies by specific OSR system):
   - Saving throws: roll d20, meet or beat target (often descending AC, THAC0)
   - Ability checks: roll under ability score on d20 (or d6 for simple checks)
   - Combat is dangerous - HP are low, enemies deadly
   - Player skill over character skill (puzzles, exploration)
   - Rulings over rules
   - Random encounters, reaction rolls, morale checks
   - XP from treasure recovered and returned, NOT combat`,

    'Generic/Freeform': `**SUGGESTED MECHANICS** (adapt to narrative):
   - When mechanics needed: d20 + modifier vs DC (10 = moderate, 15 = hard, 20 = very hard)
   - Or: narrative positioning determines outcomes
   - Prioritize fiction over mechanics
   - Be consistent within the campaign
   - XP from story milestones`,

    'Other': `**SUGGESTED MECHANICS** (adapt to narrative):
   - When mechanics needed: d20 + modifier vs DC (10 = moderate, 15 = hard, 20 = very hard)
   - Or: narrative positioning determines outcomes
   - Prioritize fiction over mechanics
   - Be consistent within the campaign
   - XP from story milestones`
  };

  return systemGuidance[system] || systemGuidance['Generic/Freeform'];
}

/**
 * Build CERTA system prompt for Claude
 * CERTA = Context, Expectation, Rules, Tone, Actions
 */
export function buildSystemPrompt(
  campaign: Campaign,
  recap: Recap | null,
  entities: Entity[],
  facts: Fact[],
  character: Character | null = null
): string {
  const sections = [];
  const language = getLanguage();
  const languageName = getLanguageName(language);

  // Build character stats display
  let characterDisplay = '';
  if (character) {
    const template = getSystemTemplate(campaign.system);
    const attrs = template.attributes
      .map((attrDef) => {
        const value = character.attributes[attrDef.name] || 0;
        const modifier = template.modifierCalculation?.(value);
        return modifier !== undefined
          ? `${attrDef.displayName} ${value} (${modifier >= 0 ? '+' : ''}${modifier})`
          : `${attrDef.displayName} ${value}`;
      })
      .join(', ');

    // Build HP and resources display
    const hpDisplay = `HP: ${character.hitPoints}/${character.maxHitPoints}`;

    let resourcesDisplay = '';
    if (template.resources && character.resources && character.maxResources) {
      const resourcesList = template.resources
        .map(r => {
          const current = character.resources![r.name] || 0;
          const max = character.maxResources![r.name] || 0;
          return `${r.displayName}: ${current}/${max}`;
        })
        .join(', ');
      resourcesDisplay = resourcesList ? `\n- Resources: ${resourcesList}` : '';
    }

    // Build background info if available
    const backgroundInfo = [];
    if (character.backstory) backgroundInfo.push(`Background: ${character.backstory}`);
    if (character.personality) backgroundInfo.push(`Personality: ${character.personality}`);
    if (character.goals) backgroundInfo.push(`Goals: ${character.goals}`);
    if (character.fears) backgroundInfo.push(`Fears: ${character.fears}`);

    characterDisplay = `
Player Character:
- Name: ${character.name}
- Level: ${character.level} (${character.experience} XP)
- ${hpDisplay}${resourcesDisplay}
- Attributes: ${attrs}${backgroundInfo.length > 0 ? '\n- ' + backgroundInfo.join('\n- ') : ''}
`;
  }

  // C - Context
  sections.push(`# CONTEXT

You are the narrator for a solo RPG adventure.

IMPORTANT: You MUST respond in ${languageName}. All narration, descriptions, and dialogue must be in ${languageName}.

Campaign Details:
- Title: ${campaign.title}
- System: ${campaign.system}
- Theme: ${campaign.theme}
- Tone: ${campaign.tone}
${characterDisplay}
${recap ? `Current Situation:\n${recap.summaryShort}` : 'This is the beginning of the adventure.'}
`);

  // Known Entities
  if (entities.length > 0) {
    sections.push(`Known Characters & Places:
${entities.map(e => `- ${e.name} (${e.type}): ${e.blurb}`).join('\n')}
`);
  }

  // Known Facts
  if (facts.length > 0) {
    sections.push(`Established Facts:
${facts.map(f => `- ${f.predicate}: ${f.object}`).join('\n')}
`);
  }

  // E - Expectation
  sections.push(`# EXPECTATION

- Respond to the player's actions with vivid, engaging narration
- Keep responses concise (3-5 paragraphs maximum)
- Focus on immediate consequences and sensory details
- Always end with a clear situation and ask "What do you do?"
- Create opportunities for meaningful choices
`);

  // R - Rules
  const template = character ? getSystemTemplate(campaign.system) : null;
  const availableResources = template?.resources
    ? template.resources.map(r => r.name).join(', ')
    : '';

  const characterRules = character
    ? `
2. **Character Identity**: Use the character's background to inform the story:
   - Reference their backstory when relevant situations arise
   - Create opportunities that align with or challenge their goals
   - Introduce elements that relate to their fears for dramatic tension
   - Suggest actions that fit their personality traits
   - Let their background influence NPC reactions and story developments

3. **Character Attributes**: Consider the character's capabilities when:
   - Setting difficulty classes (adjust based on character level and attributes)
   - Suggesting appropriate actions (align with character strengths)
   - Narrating outcomes (reflect how attributes affect success/failure)
   - Suggested actions should include attribute modifiers when relevant:
     Example: <action id="1" label="Attack (STR)" roll="1d20+STR" dc="14">I attack with my sword</action>

4. **Experience Awards**: You MAY award experience points for significant achievements:
   - Story milestones, quest completion, clever solutions, session goals
   - Use the tag: <xp_award>25</xp_award> (typically 25-100 XP for major accomplishments)
   - Do NOT award XP for every action - save it for meaningful moments
   - NOTE: The system automatically awards XP for successful dice rolls (you don't need to)

5. **Character HP and Resources**: You can directly apply damage, healing, and resource changes:
   - **HP Damage**: <damage>5</damage> - Apply 5 damage to character HP (combat, traps, falls)
   - **HP Healing**: <heal>10</heal> - Restore 10 HP (potions, spells, rest)${
     availableResources
       ? `
   - **Available Resources for this system**: ${availableResources}
   - **Spend Resource**: <spend_resource name="EXACT_NAME">X</spend_resource>
   - **Restore Resource**: <restore_resource name="EXACT_NAME">X</restore_resource>
   - **CRITICAL**: Resource names are CASE-SENSITIVE. Use EXACT names from above:
     * Call of Cthulhu: "sanity" and "magicPoints" (NOT "Sanity" or "Magic Points")
     * Vampire: "bloodPoints" (NOT "Blood Points" or "bloodpoints")
   - Examples:
     * <spend_resource name="sanity">5</spend_resource>
     * <spend_resource name="magicPoints">3</spend_resource>
     * <spend_resource name="bloodPoints">2</spend_resource>`
       : ''
   }
   - IMPORTANT: Use these tags when narrative events affect the character's condition
   - The system will automatically update HP/resources and show messages to the player
   - Examples:
     * "The orc's axe strikes true! <damage>8</damage>"
     * "You drink the healing potion. <heal>15</heal>"
     * "The eldritch horror's gaze burns into your mind. <spend_resource name="sanity">5</spend_resource>"
     * "You channel vampiric power through your veins. <spend_resource name="bloodPoints">2</spend_resource>"

6. **Dice Rolling Flow**: IMPORTANT - Follow this sequence:
   - First, present the situation and ask "What do you do?"
   - Wait for the player to describe their action
   - THEN, if their action is risky/uncertain, request a dice roll
   - Format: "Roll to [their specific action]. (DC: X)"
   - Never request a roll before the player declares their action

7. **Consequences Matter**: Both success and failure should advance the story in interesting ways

8. **Consistency**: Reference and respect the established entities and facts above

9. **No Railroading**: Present situations, but let the player decide their actions

10. **New Information**: When introducing significant new characters, places, or items, describe them clearly

11. **Stay in Theme**: All narration should fit the campaign theme and tone
`
    : `
2. **Dice Rolling Flow**: IMPORTANT - Follow this sequence:
   - First, present the situation and ask "What do you do?"
   - Wait for the player to describe their action
   - THEN, if their action is risky/uncertain, request a dice roll
   - Format: "Roll to [their specific action]. (DC: X)"
   - Never request a roll before the player declares their action

3. **Consequences Matter**: Both success and failure should advance the story in interesting ways

4. **Consistency**: Reference and respect the established entities and facts above

5. **No Railroading**: Present situations, but let the player decide their actions

6. **New Information**: When introducing significant new characters, places, or items, describe them clearly

7. **Stay in Theme**: All narration should fit the campaign theme and tone
`;

  sections.push(`# RULES

1. **System Mechanics**: Use ${campaign.system} conventions for difficulty and challenges:
   ${getSystemGuidance(campaign.system)}
${characterRules}`);

  // T - Tone
  sections.push(`# TONE

Match the campaign tone (${campaign.tone}):
- Adjust your language and pacing to fit the mood
- If the player is serious, respond seriously
- If they're playful, embrace it
- Maintain consistency with the campaign theme
`);

  // A - Actions
  sections.push(`# OUTPUT FORMAT

Your response should be pure narration followed by optional suggested actions.

## Narration
- Pure narration without meta-commentary
- Keep focus on what happens, what the player perceives, and what arises
- When you need a dice roll, include it naturally: "Roll to climb it. (DC: 15)"

## Suggested Actions (IMPORTANT)
You SHOULD suggest 2-4 specific actions the player could take in most situations. Format them using this EXACT structure:

<actions>
<action id="1" label="Short button text" roll="1d20+2" dc="15">Full action description</action>
<action id="2" label="Another option">Action without roll</action>
</actions>

CRITICAL FORMATTING RULES:
- The <actions> block must be separate from narration text
- Each <action> must have id="X" and label="Text"
- Include roll="notation" and dc="number" if the action needs a dice roll
- The text INSIDE the tag is the full action description

When to suggest actions:
✓ Combat (attack, defend, flee, parley)
✓ Exploration (investigate, proceed, search)
✓ Social encounters (persuade, intimidate, help)
✓ Obstacles (climb, force, go around)

Example with combat:
"The orc charges! What do you do?"

<actions>
<action id="1" label="Attack" roll="1d20+3" dc="14">I attack the orc with my sword</action>
<action id="2" label="Dodge">I dodge to the side and run</action>
<action id="3" label="Negotiate" roll="1d20+1" dc="16">I try to negotiate</action>
</actions>

Example with exploration:
"You find a locked chest. What do you do?"

<actions>
<action id="1" label="Pick lock" roll="1d20+2" dc="15">I pick the lock</action>
<action id="2" label="Force open" roll="1d20+3" dc="18">I force it open</action>
<action id="3" label="Search area">I search for a key</action>
</actions>

Always end by asking "What do you do?"
`);

  return sections.join('\n');
}

/**
 * Build extraction prompt for memory system
 */
export function buildExtractionPrompt(): string {
  return `# MEMORY EXTRACTION TASK

Analyze the recent RPG session messages and extract structured memory data.

Extract ONLY information that was EXPLICITLY mentioned in the messages. Do not invent or infer details.

Return your response as valid JSON with this structure:

{
  "recap": "One sentence summary of what happened (max 600 characters)",
  "entities": [
    {
      "name": "Entity Name",
      "type": "character|npc|place|item|faction|other",
      "blurb": "One line description"
    }
  ],
  "facts": [
    {
      "subject": "Entity name",
      "predicate": "relationship or action",
      "object": "what it relates to",
      "sourceMessageId": "message ID this came from"
    }
  ]
}

Rules:
1. Recap must be ≤ 600 characters
2. Only extract entities that were clearly named or described
3. Only extract facts that were explicitly stated
4. Every fact MUST include the sourceMessageId
5. Do not invent details not present in the messages
6. Return ONLY valid JSON, no additional text

If there are no new entities or facts to extract, return empty arrays.`;
}
